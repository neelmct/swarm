version: '3.7'
  
networks:
  internal:
    driver: overlay
  unifi_macvlan:
    external: true
  proxy:
    external: true

services:
  controller:
    image: jacobalberty/unifi
    init: true
    networks:
      - unifi_macvlan
      - proxy
      - internal
#    volumes:
#      - /mnt/swarm/volumes/unifi/controller:/unifi
    sysctls:
      net.ipv4.ip_unprivileged_port_start: 0
    environment:
      DB_URI: mongodb://mongo/unifi
      STATDB_URI: mongodb://mongo/unifi_stat
      DB_NAME: unifi
    ports:
      - "8083:8443/tcp"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - "node.role==worker"
      labels:
        - "traefik.enable=false"

  mongo:
    image: mongo:3.6
    networks:
      - internal
#    volumes:
#      - /mnt/swarm/volumes/unifi/mongo:/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - "node.role==worker"
      labels:
        - "traefik.enable=false"